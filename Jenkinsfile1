stage('Config & Deployment') {
  steps {
    withCredentials([
      [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'awsid1'],
      file(credentialsId: 'ec2-ssh-key', variable: 'PEM')
    ]) {
      sh '''
        set -e
        echo "🔑 Using saijenkins1.pem from Jenkins credentials..."
        cp "$PEM" terraform-files/saijenkins1.pem
        chmod 600 terraform-files/saijenkins1.pem

        echo "✅ Checking AWS identity..."
        aws sts get-caller-identity --region us-east-1

        cd terraform-files
        terraform init -input=false
        terraform validate

        echo "🚀 Applying Terraform configuration..."
        terraform apply --auto-approve -var "private_key_path=saijenkins1.pem"

        echo "🌍 Instance created successfully!"
        terraform output || true

        echo "🧹 Cleaning up PEM..."
        rm -f saijenkins1.pem
      '''
    }
  }
}
