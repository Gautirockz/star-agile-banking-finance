pipeline {
    agent any

    tools {
        // Install the Maven version configured as "M3" and add it to the .
        maven "mymaven1"
    }

    stages {
        stage('Build') {
            steps {
            git url: 'https://github.com/Gautirockz/star-agile-banking-finance.git', branch: 'master'
                sh "mvn -Dmaven.test.failure.ignore=true clean package"
                  }        
        }
stage('Create Docker Image') {
  steps {
    sh 'docker build -t saigowtham2605/financeme1:1.0 .'
  }
}
  stage('Docker-Login') {
           steps {
              withCredentials([usernamePassword(credentialsId: 'dockercreds', passwordVariable: 'dockerpassword', usernameVariable: 'dockervariable')]) {
              sh '''
                        set -e
                        echo "$dockerpassword" | docker login -u "$dockervariable" --password-stdin
                    '''
                                   }
                        }
                }
       stage('Push-Image') {
           steps {
               sh 'docker push  saigowtham2605/financeme1:1.0'
                     }
                }
stage('Config & Deployment') {
  steps {
    withCredentials([
      aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'awsid1', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'),
      sshUserPrivateKey(credentialsId: 'saijenkins1', keyFileVariable: 'PEM')
    ]) {
      sh '''
        cp "$PEM" saijenkins1.pem
        chmod 600 saijenkins1.pem
        aws sts get-caller-identity --region ap-south-1 || true

        cd terraform-files
        terraform init
        terraform validate
        terraform apply --auto-approve
      '''
    }
  }
}

}
}

